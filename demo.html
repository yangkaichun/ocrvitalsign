<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 與血壓計掃描器 (修正版)</title>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --background-color: #f8f9fa;
            --text-color: #212529; --card-bg: #ffffff; --border-color: #dee2e6;
            --success-color: #28a745; --danger-color: #dc3545;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 1rem; background-color: var(--background-color); color: var(--text-color);
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
      .container { width: 100%; max-width: 600px; margin: 0 auto; }
        h1 { color: var(--primary-color); text-align: center; margin-bottom: 1.5rem; }
      .card {
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #qr-reader {
            width: 100%; border: 1px solid var(--border-color); border-radius: 0.5rem;
            overflow: hidden; position: relative; min-height: 250px;
            display: flex; justify-content: center; align-items: center;
            color: var(--secondary-color); font-style: italic; background-color: #e9ecef;
        }
        #qr-reader video {
            display: block; width: 100%; height: auto; object-fit: cover;
        }
        #blood-pressure-overlay {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 80%; height: 30%;
            border: 3px solid var(--danger-color); box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            border-radius: 10px; display: none;
        }
      .controls,.results-container { text-align: center; }
        button {
            background-color: var(--primary-color); color: white; border: none;
            padding: 0.75rem 1.5rem; font-size: 1rem; border-radius: 0.25rem;
            cursor: pointer; transition: background-color 0.2s, opacity 0.2s; margin: 0.5rem;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: var(--secondary-color); cursor: not-allowed; opacity: 0.65; }
      .result-item { margin-bottom: 1rem; }
      .result-item h3 { margin: 0 0 0.5rem 0; color: var(--secondary-color); }
      .result-item p { margin: 0; font-size: 1.2rem; font-weight: bold; color: var(--success-color); word-wrap: break-word; }
      .status { margin-top: 1rem; font-style: italic; color: var(--secondary-color); min-height: 1.5em; text-align: center; }
      .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>整合式掃描器 (修正版)</h1>
        <div class="card">
            <div id="qr-reader">相機預覽區</div>
            <div id="blood-pressure-overlay"></div>
        </div>
        <div id="controls" class="card controls">
            <button id="start-scan-btn">1. 開始掃描 QR Code</button>
            <button id="open-bp-camera-btn">2. 擷取血壓數值</button>
            <button id="capture-bp-value-btn">擷取</button>
            <button id="reset-btn">重新開始</button>
        </div>
        <div id="results-container" class="card results-container">
            <div id="qr-result" class="result-item">
                <h3>QR Code 內容</h3>
                <p id="qr-result-text"></p>
            </div>
            <div id="bp-result" class="result-item">
                <h3>血壓計讀數</h3>
                <p id="bp-result-text"></p>
            </div>
        </div>
        <p id="status" class="status">正在初始化應用程式...</p>
    </div>

    <canvas id="ocr-canvas" style="display:none;"></canvas>

    <script src="[https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js](https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js)"></script>
    <script src="[https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js](https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js)"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // ===================================================================
        // == UIManager: 處理所有 DOM 操作
        // ===================================================================
        const UIManager = {
            elements: {
                qrReader: document.getElementById('qr-reader'),
                bpOverlay: document.getElementById('blood-pressure-overlay'),
                startScanBtn: document.getElementById('start-scan-btn'),
                openBpCameraBtn: document.getElementById('open-bp-camera-btn'),
                captureBpValueBtn: document.getElementById('capture-bp-value-btn'),
                resetBtn: document.getElementById('reset-btn'),
                resultsContainer: document.getElementById('results-container'),
                qrResultDiv: document.getElementById('qr-result'),
                qrResultText: document.getElementById('qr-result-text'),
                bpResultDiv: document.getElementById('bp-result'),
                bpResultText: document.getElementById('bp-result-text'),
                status: document.getElementById('status'),
                ocrCanvas: document.getElementById('ocr-canvas'),
            },
            getOcrContext: function() {
                return this.elements.ocrCanvas.getContext('2d', { willReadFrequently: true });
            },
            updateUIForState: function(state, data = {}) {
                const allButtons =;
                allButtons.forEach(btn => { btn.classList.add('hidden'); btn.disabled = false; });

                this.elements.bpOverlay.style.display = 'none';
                this.elements.resultsContainer.classList.add('hidden');
                this.elements.qrResultDiv.classList.add('hidden');
                this.elements.bpResultDiv.classList.add('hidden');

                switch (state) {
                    case 'IDLE':
                        this.elements.startScanBtn.classList.remove('hidden');
                        this.elements.qrReader.innerHTML = '相機預覽區';
                        this.elements.status.textContent = '請點擊按鈕開始掃描 QR Code。';
                        break;
                    case 'INITIALIZING_QR':
                        this.elements.startScanBtn.classList.remove('hidden');
                        this.elements.startScanBtn.disabled = true;
                        this.elements.status.textContent = '正在請求相機權限...';
                        this.elements.qrReader.innerHTML = '';
                        break;
                    case 'SCANNING_QR':
                        this.elements.status.textContent = '請將 QR Code 對準掃描框。';
                        break;
                    case 'AWAITING_OCR':
                        this.elements.openBpCameraBtn.classList.remove('hidden');
                        this.elements.resetBtn.classList.remove('hidden');
                        this.elements.resultsContainer.classList.remove('hidden');
                        this.elements.qrResultDiv.classList.remove('hidden');
                        this.elements.qrResultText.textContent = data.qrData;
                        this.elements.qrReader.innerHTML = '相機已關閉';
                        this.elements.status.textContent = 'QR Code 掃描成功！請準備掃描血壓計。';
                        break;
                    case 'INITIALIZING_OCR':
                        this.elements.openBpCameraBtn.classList.remove('hidden');
                        this.elements.openBpCameraBtn.disabled = true;
                        this.elements.resetBtn.classList.remove('hidden');
                        this.elements.resultsContainer.classList.remove('hidden');
                        this.elements.qrResultDiv.classList.remove('hidden');
                        this.elements.qrResultText.textContent = data.qrData;
                        this.elements.status.textContent = '正在啟動相機以擷取血壓計...';
                        this.elements.qrReader.innerHTML = '';
                        break;
                    case 'SCANNING_OCR':
                        this.elements.captureBpValueBtn.classList.remove('hidden');
                        this.elements.resetBtn.classList.remove('hidden');
                        this.elements.resultsContainer.classList.remove('hidden');
                        this.elements.qrResultDiv.classList.remove('hidden');
                        this.elements.qrResultText.textContent = data.qrData;
                        this.elements.bpOverlay.style.display = 'block';
                        this.elements.status.textContent = '請將血壓計螢幕對準紅框，然後點擊「擷取」。';
                        break;
                    case 'PROCESSING_OCR':
                        this.elements.captureBpValueBtn.classList.remove('hidden');
                        this.elements.captureBpValueBtn.disabled = true;
                        this.elements.resetBtn.classList.remove('hidden');
                        this.elements.resultsContainer.classList.remove('hidden');
                        this.elements.qrResultDiv.classList.remove('hidden');
                        this.elements.qrResultText.textContent = data.qrData;
                        this.elements.bpResultDiv.classList.remove('hidden');
                        this.elements.bpResultText.textContent = '處理中...';
                        this.elements.bpOverlay.style.display = 'block';
                        this.elements.status.textContent = '正在辨識影像...';
                        break;
                    case 'COMPLETE':
                        this.elements.resetBtn.classList.remove('hidden');
                        this.elements.resultsContainer.classList.remove('hidden');
                        this.elements.qrResultDiv.classList.remove('hidden');
                        this.elements.qrResultText.textContent = data.qrData;
                        this.elements.bpResultDiv.classList.remove('hidden');
                        this.elements.bpResultText.textContent = data.bpData;
                        this.elements.qrReader.innerHTML = '掃描完成';
                        this.elements.status.textContent = '所有掃描均已完成！';
                        break;
                    case 'ERROR':
                        this.elements.resetBtn.classList.remove('hidden');
                        this.elements.status.textContent = `發生錯誤: ${data.error}`;
                        this.elements.qrReader.innerHTML = '錯誤';
                        break;
                }
            },
            updateOcrProgress: function(message) {
                this.elements.status.textContent = message;
            },
            setBpResult: function(text) {
                this.elements.bpResultText.textContent = text;
            },
        };

        // ===================================================================
        // == CameraManager: 封裝所有 html5-qrcode 邏輯
        // ===================================================================
        const CameraManager = {
            html5QrCode: null,
            isScanning: false,
            init: function() {
                this.html5QrCode = new Html5Qrcode(UIManager.elements.qrReader.id, { verbose: false });
            },
            async start(config, successCallback, errorCallback) {
                if (this.isScanning) {
                    console.warn("相機已在掃描中，請先停止再重新啟動。");
                    await this.stop();
                }
                console.log("正在啟動相機，設定:", config);
                try {
                    await this.html5QrCode.start(
                        { facingMode: "environment" },
                        config,
                        successCallback,
                        (errorMessage) => { /* 忽略 QR code 未找到的錯誤 */ }
                    );
                    this.isScanning = true;
                    console.log("相機啟動成功。");
                } catch (err) {
                    console.error("啟動相機失敗:", err);
                    this.isScanning = false;
                    errorCallback(err);
                }
            },
            async stop() {
                if (!this.isScanning ||!this.html5QrCode) {
                    console.log("相機未在掃描中，無需停止。");
                    return;
                }
                try {
                    console.log("正在停止相機...");
                    await this.html5QrCode.stop();
                    this.isScanning = false;
                    console.log("相機已成功停止。");
                } catch (err) {
                    console.error("無法正常停止相機:", err);
                    this.isScanning = false;
                    // Fallback: 嘗試清理殘留的 video 元素
                    try {
                        this.html5QrCode.clear();
                    } catch (clearErr) {
                        console.error("停止失敗後，清理也失敗:", clearErr);
                    }
                }
            },
            captureFrame: function() {
                const videoElement = UIManager.elements.qrReader.querySelector('video');
                if (!videoElement |

| videoElement.readyState < 2) {
                    throw new Error("影片串流尚未就緒，無法擷取畫面。");
                }
                return videoElement;
            }
        };

        // ===================================================================
        // == OCRProcessor: 管理 Tesseract.js worker 和影像處理
        // ===================================================================
        const OCRProcessor = {
            worker: null,
            isInitialized: false,
            async init() {
                if (this.isInitialized) return;
                UIManager.updateOcrProgress('正在載入 OCR 引擎...');
                try {
                    this.worker = await Tesseract.createWorker('eng', 1, {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                UIManager.updateOcrProgress(`OCR 辨識中... (${Math.round(m.progress * 100)}%)`);
                            }
                        },
                    });
                    await this.worker.setParameters({
                        tessedit_char_whitelist: '0123456789/SYSPUL',
                    });
                    this.isInitialized = true;
                    console.log("Tesseract worker 初始化成功。");
                } catch (err) {
                    console.error("Tesseract worker 初始化失敗:", err);
                    this.isInitialized = false;
                    throw new Error("OCR 引擎載入失敗。");
                }
            },
            async recognize(videoElement) {
                if (!this.isInitialized) {
                    await this.init();
                }
                const canvas = this.preprocessImage(videoElement);
                const { data: { text } } = await this.worker.recognize(canvas);
                console.log('OCR 原始結果:', text);
                return this.parseBPResult(text);
            },
            preprocessImage(videoElement) {
                const canvas = UIManager.elements.ocrCanvas;
                const ctx = UIManager.getOcrContext();
                const overlay = UIManager.elements.bpOverlay;

                const videoRect = videoElement.getBoundingClientRect();
                const overlayRect = overlay.getBoundingClientRect();
                
                const scaleX = videoElement.videoWidth / videoRect.width;
                const scaleY = videoElement.videoHeight / videoRect.height;
                
                const sx = (overlayRect.left - videoRect.left) * scaleX;
                const sy = (overlayRect.top - videoRect.top) * scaleY;
                const sWidth = overlayRect.width * scaleX;
                const sHeight = overlayRect.height * scaleY;

                canvas.width = sWidth;
                canvas.height = sHeight;

                ctx.drawImage(videoElement, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);
                
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let data = imageData.data;

                // 灰階、增強對比度、二值化
                for (let i = 0; i < data.length; i += 4) {
                    let gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    const contrast = 2.0;
                    gray = (gray - 128) * contrast + 128;
                    gray = Math.max(0, Math.min(255, gray));
                    const threshold = 150;
                    const color = gray > threshold? 255 : 0;
                    data[i] = data[i + 1] = data[i + 2] = color;
                }
                ctx.putImageData(imageData, 0, 0);
                
                return canvas;
            },
            parseBPResult(text) {
                const cleanedText = text.replace(/[\s\n\r]/g, '').replace(/o/gi, '0').replace(/l/gi, '1').replace(/s/gi, '5');
                // **FIXED**: Correctly capture groups from the regex match
                const match = cleanedText.match(/(\d{2,3})\/?(\d{2,3})/);
                if (match && match.length >= 3) {
                    return `收縮壓: ${match[1]} / 舒張壓: ${match[2]}`;
                }
                return `無法解析，原始辨識文字: "${cleanedText}"`;
            },
            async terminate() {
                if (this.worker) {
                    await this.worker.terminate();
                    this.worker = null;
                    this.isInitialized = false;
                    console.log("Tesseract worker 已終止。");
                }
            }
        };

        // ===================================================================
        // == Finite State Machine (FSM): 中央控制器
        // ===================================================================
        const AppFSM = {
            currentState: 'IDLE',
            qrData: null,
            transitions: {
                IDLE:           { START_QR_SCAN: 'INITIALIZING_QR' },
                INITIALIZING_QR:{ CAMERA_STARTED: 'SCANNING_QR', FAIL: 'ERROR', RESET: 'IDLE' },
                SCANNING_QR:    { QR_SUCCESS: 'AWAITING_OCR', RESET: 'IDLE' },
                AWAITING_OCR:   { START_OCR_SCAN: 'INITIALIZING_OCR', RESET: 'IDLE' },
                INITIALIZING_OCR:{ CAMERA_STARTED: 'SCANNING_OCR', FAIL: 'ERROR', RESET: 'IDLE' },
                SCANNING_OCR:   { CAPTURE: 'PROCESSING_OCR', RESET: 'IDLE' },
                PROCESSING_OCR: { OCR_SUCCESS: 'COMPLETE', OCR_FAIL: 'SCANNING_OCR', RESET: 'IDLE' },
                COMPLETE:       { RESET: 'IDLE' },
                ERROR:          { RESET: 'IDLE' }
            },
            async dispatch(action, payload = {}) {
                // **FIXED**: The core logic of the FSM transition was incorrect.
                // It must check the transition from the *current* state.
                const nextState = this.transitions?.[action];
                
                if (!nextState) {
                    console.warn(`無效的轉換: 從 ${this.currentState} 執行 ${action}`);
                    return;
                }
                
                console.log(`狀態轉換: ${this.currentState} -> ${nextState} (動作: ${action})`);
                this.currentState = nextState;
                
                // --- 處理進入新狀態的邏輯 ---
                switch (this.currentState) {
                    case 'INITIALIZING_QR':
                        UIManager.updateUIForState(this.currentState, { qrData: this.qrData,...payload });
                        await CameraManager.start(
                            { fps: 10, qrbox: { width: 250, height: 250 } },
                            (decodedText, decodedResult) => {
                                if (this.currentState === 'SCANNING_QR') {
                                    this.qrData = decodedText;
                                    this.dispatch('QR_SUCCESS');
                                }
                            },
                            (err) => this.dispatch('FAIL', { error: '無法啟動 QR 掃描相機。' })
                        );
                        if (CameraManager.isScanning) this.dispatch('CAMERA_STARTED');
                        break;

                    case 'SCANNING_QR':
                        UIManager.updateUIForState(this.currentState, { qrData: this.qrData,...payload });
                        break;
                        
                    case 'AWAITING_OCR':
                        await CameraManager.stop();
                        UIManager.updateUIForState(this.currentState, { qrData: this.qrData,...payload });
                        break;

                    case 'INITIALIZING_OCR':
                        UIManager.updateUIForState(this.currentState, { qrData: this.qrData,...payload });
                        await CameraManager.start(
                            { fps: 5 },
                            () => {}, // OCR 模式下不需要成功回調
                            (err) => this.dispatch('FAIL', { error: '無法啟動血壓計掃描相機。' })
                        );
                        if (CameraManager.isScanning) this.dispatch('CAMERA_STARTED');
                        break;
                    
                    case 'SCANNING_OCR':
                        UIManager.updateUIForState(this.currentState, { qrData: this.qrData,...payload });
                        break;

                    case 'PROCESSING_OCR':
                        UIManager.updateUIForState(this.currentState, { qrData: this.qrData,...payload });
                        try {
                            const videoElement = CameraManager.captureFrame();
                            const bpData = await OCRProcessor.recognize(videoElement);
                            await CameraManager.stop();
                            this.dispatch('OCR_SUCCESS', { bpData });
                        } catch (err) {
                            console.error("OCR 處理失敗:", err);
                            UIManager.setBpResult(`辨識失敗: ${err.message}`);
                            this.dispatch('OCR_FAIL');
                        }
                        break;
                    
                    case 'COMPLETE':
                        UIManager.updateUIForState(this.currentState, { qrData: this.qrData,...payload });
                        break;

                    case 'IDLE':
                        await CameraManager.stop();
                        await OCRProcessor.terminate();
                        this.qrData = null;
                        UIManager.elements.qrResultText.textContent = '';
                        UIManager.elements.bpResultText.textContent = '';
                        UIManager.updateUIForState(this.currentState);
                        break;

                    case 'ERROR':
                        await CameraManager.stop();
                        UIManager.updateUIForState(this.currentState, payload);
                        break;
                }
            }
        };

        // ===================================================================
        // == 事件監聽器: 連接 UI 與 FSM
        // ===================================================================
        UIManager.elements.startScanBtn.addEventListener('click', () => AppFSM.dispatch('START_QR_SCAN'));
        UIManager.elements.openBpCameraBtn.addEventListener('click', () => AppFSM.dispatch('START_OCR_SCAN'));
        UIManager.elements.captureBpValueBtn.addEventListener('click', () => AppFSM.dispatch('CAPTURE'));
        UIManager.elements.resetBtn.addEventListener('click', () => AppFSM.dispatch('RESET'));

        // ===================================================================
        // == 應用程式初始化
        // ===================================================================
        async function main() {
            UIManager.updateUIForState('IDLE');
            CameraManager.init();
            try {
                await OCRProcessor.init();
                UIManager.updateOcrProgress(''); // 清除載入訊息
            } catch (err) {
                AppFSM.dispatch('FAIL', { error: err.message });
            }
        }

        main();
    });
    </script>
</body>
</html>
