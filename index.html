<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫療數據掃描器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">
            <i class="fas fa-heartbeat mr-2"></i>醫療數據掃描器
        </h1>
        
        <!-- 操作按鍵 -->
        <div class="grid grid-cols-1 gap-4 mb-6">
            <button id="qrScanBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition duration-300">
                <i class="fas fa-qrcode mr-2"></i>掃描 QR Code
            </button>
            <button id="medicalScanBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition duration-300">
                <i class="fas fa-camera mr-2"></i>掃描醫療設備數值
            </button>
        </div>

        <!-- 文件上傳區域 -->
        <div id="uploadArea" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <i class="fas fa-upload text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-4">點擊上傳圖片或拖拽圖片到此處</p>
                <input type="file" id="imageInput" accept="image/*" capture="camera" class="hidden">
                <button id="uploadBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    選擇圖片
                </button>
            </div>
        </div>

        <!-- 相機預覽區域 -->
        <div id="cameraContainer" class="hidden bg-white rounded-lg shadow-lg p-4 mb-6">
            <video id="video" class="w-full rounded-lg" autoplay playsinline></video>
            <canvas id="canvas" class="hidden"></canvas>
            <div class="mt-4 text-center">
                <button id="captureBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 mr-2">
                    <i class="fas fa-camera mr-2"></i>拍照
                </button>
                <button id="stopCameraBtn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-stop mr-2"></i>停止
                </button>
            </div>
        </div>

        <!-- 處理狀態 -->
        <div id="processingStatus" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                <span id="statusText">處理中...</span>
            </div>
        </div>

        <!-- 測試按鈕 -->
        <div class="mb-6">
            <button id="testBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300">
                <i class="fas fa-test-tube mr-2"></i>測試辨識 (血壓: 122/78, 心率: 66)
            </button>
        </div>

        <!-- 結果顯示區域 -->
        <div id="resultsContainer" class="hidden">
            <!-- QR Code 結果 -->
            <div id="qrResult" class="hidden bg-white rounded-lg shadow-lg p-6 mb-4">
                <h3 class="text-lg font-semibold mb-3 text-blue-600">
                    <i class="fas fa-qrcode mr-2"></i>QR Code 掃描結果
                </h3>
                <div id="qrContent" class="bg-gray-100 p-3 rounded border break-all"></div>
            </div>

            <!-- 醫療數據結果 -->
            <div id="medicalResult" class="hidden bg-white rounded-lg shadow-lg p-6 mb-4">
                <h3 class="text-lg font-semibold mb-3 text-green-600">
                    <i class="fas fa-heartbeat mr-2"></i>生理數據辨識結果
                </h3>
                <div id="medicalData" class="space-y-3">
                    <div id="bloodPressure" class="hidden">
                        <span class="font-medium text-red-600">血壓:</span>
                        <span id="systolic" class="mx-2"></span>/<span id="diastolic"></span> mmHg
                    </div>
                    <div id="heartRate" class="hidden">
                        <span class="font-medium text-blue-600">心率:</span>
                        <span id="pulse" class="mx-2"></span> bpm
                    </div>
                    <div id="bloodOxygen" class="hidden">
                        <span class="font-medium text-green-600">血氧:</span>
                        <span id="spo2" class="mx-2"></span>%
                    </div>
                    <div id="bloodSugar" class="hidden">
                        <span class="font-medium text-purple-600">血糖:</span>
                        <span id="glucose" class="mx-2"></span> mg/dL
                    </div>
                </div>
                <div id="rawOcrText" class="mt-4 p-3 bg-gray-100 rounded text-sm">
                    <strong>原始辨識文字:</strong>
                    <div id="ocrContent" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStream = null;
        let currentMode = null; // 'qr' or 'medical'

        // DOM 元素
        const qrScanBtn = document.getElementById('qrScanBtn');
        const medicalScanBtn = document.getElementById('medicalScanBtn');
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const cameraContainer = document.getElementById('cameraContainer');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const processingStatus = document.getElementById('processingStatus');
        const statusText = document.getElementById('statusText');
        const resultsContainer = document.getElementById('resultsContainer');
        const qrResult = document.getElementById('qrResult');
        const medicalResult = document.getElementById('medicalResult');
        const testBtn = document.getElementById('testBtn');

        // 事件監聽器
        qrScanBtn.addEventListener('click', () => startScanning('qr'));
        medicalScanBtn.addEventListener('click', () => startScanning('medical'));
        uploadBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', handleImageUpload);
        captureBtn.addEventListener('click', captureImage);
        stopCameraBtn.addEventListener('click', stopCamera);
        testBtn.addEventListener('click', testRecognition);

        // 開始掃描
        async function startScanning(mode) {
            currentMode = mode;
            hideResults();
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    video.srcObject = currentStream;
                    cameraContainer.classList.remove('hidden');
                    uploadArea.classList.add('hidden');
                    
                    if (mode === 'qr') {
                        startQRScanning();
                    }
                } catch (err) {
                    console.error('無法訪問相機:', err);
                    // 如果無法訪問相機，顯示文件上傳選項
                    uploadArea.classList.remove('hidden');
                    cameraContainer.classList.add('hidden');
                }
            } else {
                // 瀏覽器不支持相機，顯示文件上傳選項
                uploadArea.classList.remove('hidden');
                cameraContainer.classList.add('hidden');
            }
        }

        // QR Code 持續掃描
        function startQRScanning() {
            const scanQR = () => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code && code.data) {
                        displayQRResult(code.data);
                        stopCamera();
                        return;
                    }
                }
                
                if (currentStream && currentMode === 'qr') {
                    requestAnimationFrame(scanQR);
                }
            };
            scanQR();
        }

        // 拍照
        function captureImage() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                processImage(blob);
            }, 'image/jpeg', 0.8);
            
            stopCamera();
        }

        // 停止相機
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            cameraContainer.classList.add('hidden');
            uploadArea.classList.add('hidden');
        }

        // 處理圖片上傳
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processImage(file);
            }
        }

        // 處理圖片
        async function processImage(imageSource) {
            showProcessing('處理圖片中...');
            
            if (currentMode === 'qr') {
                await processQRImage(imageSource);
            } else if (currentMode === 'medical') {
                await processMedicalImage(imageSource);
            }
            
            hideProcessing();
        }

        // 處理 QR Code 圖片
        async function processQRImage(imageSource) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const img = new Image();
            
            return new Promise((resolve) => {
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code && code.data) {
                        displayQRResult(code.data);
                    } else {
                        alert('未找到 QR Code，請重試');
                    }
                    resolve();
                };
                
                if (imageSource instanceof Blob) {
                    img.src = URL.createObjectURL(imageSource);
                } else {
                    const reader = new FileReader();
                    reader.onload = e => img.src = e.target.result;
                    reader.readAsDataURL(imageSource);
                }
            });
        }

        // 處理醫療設備圖片
        async function processMedicalImage(imageSource) {
            try {
                statusText.textContent = 'OCR 辨識中...';
                
                const { data: { text } } = await Tesseract.recognize(
                    imageSource,
                    'eng+chi_tra',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                statusText.textContent = `OCR 辨識中... ${Math.round(m.progress * 100)}%`;
                            }
                        }
                    }
                );
                
                parseMedicalData(text);
            } catch (error) {
                console.error('OCR 辨識失敗:', error);
                alert('OCR 辨識失敗，請重試');
            }
        }

        // 解析醫療數據
        function parseMedicalData(text) {
            const data = {
                systolic: null,
                diastolic: null,
                pulse: null,
                spo2: null,
                glucose: null
            };
            
            // 血壓辨識 (收縮壓/舒張壓)
            const bpRegex = /(\d{2,3})\s*[\/\-]\s*(\d{2,3})/g;
            const bpMatch = bpRegex.exec(text);
            if (bpMatch) {
                data.systolic = parseInt(bpMatch[1]);
                data.diastolic = parseInt(bpMatch[2]);
            }
            
            // 心率/脈搏辨識
            const pulseRegex = /(?:pulse|heart|rate|bpm|脈搏|心率|心跳)[\s:]*(\d{2,3})/gi;
            const pulseMatch = pulseRegex.exec(text);
            if (pulseMatch) {
                data.pulse = parseInt(pulseMatch[1]);
            }
            
            // 數字匹配 (用於更廣泛的數值檢測)
            const numbers = text.match(/\d{2,3}/g);
            if (numbers && numbers.length >= 3) {
                // 如果沒有通過正則找到血壓，嘗試從數字中推斷
                if (!data.systolic && !data.diastolic) {
                    const nums = numbers.map(n => parseInt(n)).filter(n => n >= 40 && n <= 250);
                    if (nums.length >= 2) {
                        nums.sort((a, b) => b - a); // 降序排列
                        data.systolic = nums[0];
                        data.diastolic = nums[1];
                    }
                }
                
                // 如果沒有找到心率，從剩餘數字中找
                if (!data.pulse) {
                    const pulseNums = numbers.map(n => parseInt(n)).filter(n => n >= 40 && n <= 200);
                    if (pulseNums.length > 0) {
                        data.pulse = pulseNums[pulseNums.length - 1]; // 通常心率是最後一個較小的數字
                    }
                }
            }
            
            displayMedicalResult(data, text);
        }

        // 測試辨識功能
        function testRecognition() {
            const testData = {
                systolic: 122,
                diastolic: 78,
                pulse: 66,
                spo2: null,
                glucose: null
            };
            
            const testText = "測試數據: 血壓 122/78 mmHg, 心率 66 bpm";
            displayMedicalResult(testData, testText);
        }

        // 顯示 QR Code 結果
        function displayQRResult(qrData) {
            document.getElementById('qrContent').textContent = qrData;
            qrResult.classList.remove('hidden');
            resultsContainer.classList.remove('hidden');
        }

        // 顯示醫療數據結果
        function displayMedicalResult(data, rawText) {
            // 血壓
            if (data.systolic && data.diastolic) {
                document.getElementById('systolic').textContent = data.systolic;
                document.getElementById('diastolic').textContent = data.diastolic;
                document.getElementById('bloodPressure').classList.remove('hidden');
            }
            
            // 心率
            if (data.pulse) {
                document.getElementById('pulse').textContent = data.pulse;
                document.getElementById('heartRate').classList.remove('hidden');
            }
            
            // 血氧
            if (data.spo2) {
                document.getElementById('spo2').textContent = data.spo2;
                document.getElementById('bloodOxygen').classList.remove('hidden');
            }
            
            // 血糖
            if (data.glucose) {
                document.getElementById('glucose').textContent = data.glucose;
                document.getElementById('bloodSugar').classList.remove('hidden');
            }
            
            // 原始辨識文字
            document.getElementById('ocrContent').textContent = rawText;
            
            medicalResult.classList.remove('hidden');
            resultsContainer.classList.remove('hidden');
        }

        // 顯示處理狀態
        function showProcessing(message) {
            statusText.textContent = message;
            processingStatus.classList.remove('hidden');
        }

        // 隱藏處理狀態
        function hideProcessing() {
            processingStatus.classList.add('hidden');
        }

        // 隱藏結果
        function hideResults() {
            resultsContainer.classList.add('hidden');
            qrResult.classList.add('hidden');
            medicalResult.classList.add('hidden');
            // 隱藏所有醫療數據項目
            document.getElementById('bloodPressure').classList.add('hidden');
            document.getElementById('heartRate').classList.add('hidden');
            document.getElementById('bloodOxygen').classList.add('hidden');
            document.getElementById('bloodSugar').classList.add('hidden');
        }

        // 拖拽上傳功能
        const uploadAreaDiv = document.querySelector('#uploadArea > div');
        uploadAreaDiv.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadAreaDiv.classList.add('border-blue-500', 'bg-blue-50');
        });

        uploadAreaDiv.addEventListener('dragleave', () => {
            uploadAreaDiv.classList.remove('border-blue-500', 'bg-blue-50');
        });

        uploadAreaDiv.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadAreaDiv.classList.remove('border-blue-500', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processImage(files[0]);
            }
        });
    </script>
</body>
</html>
